# 画像アップロード機能 仕様書

最終更新: 2025-07-15

## 1. 概要

AdLex に画像アップロード機能を追加し、画像内のテキストを OCR で抽出して薬機法違反表現をチェックする機能を実装します。

## 2. 機能仕様

### 2.1 対応画像形式・制限

- **対応形式**: JPEG, PNG, WebP, PDF
- **最大ファイルサイズ**: 10MB
- **1 回の処理制限**: 1 画像のみ
- **抽出テキスト制限**: 10,000 文字以内

### 2.2 処理フロー

1. **画像アップロード**
   - ドラッグ&ドロップまたはファイル選択
   - ファイル形式・サイズ検証
   - Supabase Storage への一時保存

2. **OCR 処理**
   - Tesseract.js（MVP）または Google Vision API で文字認識
   - 抽出テキストの前処理・クリーニング
   - 結果の一時保存

3. **テキスト編集**
   - 抽出されたテキストを編集可能な形で表示
   - ユーザーによる手動修正が可能

4. **薬機法チェック**
   - 既存のテキストチェック機能と同じ処理
   - 違反表現の検出と修正提案

## 3. 技術実装

### 3.1 データベース拡張

```sql
-- checks テーブルへの追加カラム
ALTER TABLE checks ADD COLUMN input_type VARCHAR(10) DEFAULT 'text' CHECK (input_type IN ('text', 'image'));
ALTER TABLE checks ADD COLUMN extracted_text TEXT;
ALTER TABLE checks ADD COLUMN image_url TEXT;
ALTER TABLE checks ADD COLUMN ocr_status VARCHAR(20) DEFAULT 'pending' CHECK (ocr_status IN ('pending', 'processing', 'completed', 'failed'));
ALTER TABLE checks ADD COLUMN ocr_metadata JSONB;
```

### 3.2 API エンドポイント

#### POST /api/ocr
画像アップロードと OCR 処理を開始

**リクエスト:**
```
Content-Type: multipart/form-data
- image: File
```

**レスポンス:**
```json
{
  "checkId": "uuid",
  "status": "pending",
  "message": "OCR processing started"
}
```

### 3.3 OCR 技術選定

#### Tesseract.js（MVP）
- **メリット**: 無料、クライアントサイド実行、プライバシー保護
- **デメリット**: 日本語精度が低い、処理時間が長い
- **実装**: Webブラウザ上で動作

#### Google Vision API（本格運用）
- **メリット**: 高精度日本語OCR、高速処理
- **デメリット**: 従量課金（¥15/1000画像）
- **実装**: サーバーサイド API 呼び出し

### 3.4 フロントエンド実装

#### ImageChecker コンポーネント
```typescript
interface ImageCheckerProps {
  onCheckComplete: (result: CheckResult) => void;
}

interface CheckResult {
  checkId: string;
  extractedText: string;
  modifiedText: string;
  violations: Violation[];
}
```

#### 必要なライブラリ
- `react-dropzone`: ファイルアップロード UI
- `tesseract.js`: OCR 処理（MVP）
- `@google-cloud/vision`: Vision API（本格運用）

## 4. UI/UX 設計

### 4.1 レイアウト

#### デスクトップ（3カラム）
```
┌─────────────────┬─────────────────┬─────────────────┐
│   画像プレビュー  │   抽出テキスト   │   チェック結果   │
│                 │                 │                 │
│   ドロップゾーン  │   編集可能エリア │   違反ハイライト │
│                 │                 │                 │
└─────────────────┴─────────────────┴─────────────────┘
```

#### モバイル（縦配置）
```
┌─────────────────┐
│   画像プレビュー  │
│                 │
│   ドロップゾーン  │
└─────────────────┘
┌─────────────────┐
│   抽出テキスト   │
│                 │
│   編集可能エリア │
└─────────────────┘
┌─────────────────┐
│   チェック結果   │
│                 │
│   違反ハイライト │
└─────────────────┘
```

### 4.2 ユーザーフロー

1. **画像選択**: ドラッグ&ドロップまたはクリック
2. **プレビュー**: 選択した画像を表示
3. **OCR 実行**: 「テキストを抽出」ボタンクリック
4. **進捗表示**: OCR 処理の進捗を表示
5. **結果確認**: 抽出されたテキストを確認・編集
6. **チェック実行**: 「違反チェック」ボタンクリック
7. **結果表示**: 違反箇所のハイライト表示

## 5. エラーハンドリング

### 5.1 クライアントサイドエラー

- **ファイル形式エラー**: 「対応していないファイル形式です」
- **ファイルサイズエラー**: 「ファイルサイズが10MBを超えています」
- **OCR 処理エラー**: 「文字認識に失敗しました。画像を確認してください」

### 5.2 サーバーサイドエラー

- **アップロードエラー**: 「画像のアップロードに失敗しました」
- **OCR API エラー**: 「OCR サービスが一時的に利用できません」
- **処理タイムアウト**: 「処理時間が長すぎます。画像を確認してください」

## 6. パフォーマンス考慮

### 6.1 画像最適化

- **圧縮**: アップロード前に画像を圧縮
- **リサイズ**: OCR 処理に最適なサイズに調整
- **キャッシュ**: 処理済み画像の一時キャッシュ

### 6.2 OCR 最適化

- **前処理**: 画像の傾き補正、ノイズ除去
- **並列処理**: 複数領域の並列 OCR 処理
- **結果キャッシュ**: 同一画像の結果をキャッシュ

## 7. セキュリティ

### 7.1 アップロード制限

- **MIME タイプ検証**: Content-Type の厳密チェック
- **ファイル署名検証**: マジックナンバーによる検証
- **ウイルススキャン**: 将来的にウイルススキャンを追加

### 7.2 一時ファイル管理

- **自動削除**: 処理完了後 1 時間で自動削除
- **アクセス制御**: 組織単位のアクセス制御
- **暗号化**: Storage 上でのファイル暗号化

## 8. 監視・ログ

### 8.1 メトリクス

- **処理時間**: OCR 処理時間の監視
- **成功率**: OCR 処理成功率の監視
- **エラー率**: 各種エラーの発生率監視

### 8.2 ログ

- **アップロードログ**: ファイルアップロード記録
- **OCR 処理ログ**: OCR 処理の詳細記録
- **エラーログ**: 各種エラーの詳細記録

## 9. 今後の拡張

### 9.1 機能拡張

- **一括処理**: 複数画像の一括処理
- **PDF 対応**: 複数ページ PDF の処理
- **手書き文字対応**: 手書き文字の認識精度向上

### 9.2 技術拡張

- **AI モデル**: 独自の日本語 OCR モデル
- **リアルタイム処理**: カメラ映像のリアルタイム処理
- **モバイルアプリ**: ネイティブアプリでの最適化

## 10. 開発計画

### 10.1 フェーズ 1（MVP）
- Tesseract.js による基本 OCR 機能
- 画像アップロード UI
- テキスト抽出・編集機能

### 10.2 フェーズ 2（本格運用）
- Google Vision API 統合
- 精度向上と処理速度最適化
- エラーハンドリング強化

### 10.3 フェーズ 3（拡張）
- 一括処理機能
- PDF 対応
- 監視・ログ機能強化