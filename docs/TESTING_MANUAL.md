# テストガイド

このドキュメントでは、AdLexシステムのテスト方法と、用意されているテストデータについて説明します。

## クイックスタート

### 1. 環境セットアップ

```bash
# 依存関係をインストール
npm install

# Supabaseローカル環境を起動
npm run supabase:start

# テストアカウントとデータを作成
npm run seed

# 開発サーバーを起動
npm run dev
```

### 2. ログインテスト

以下のアカウントでログインできます：

#### 管理者アカウント
- **メール**: `admin@test.com` / **パスワード**: `password123`
- **権限**: テスト組織Aの管理者
- **用途**: ユーザー招待、辞書管理、全機能のテスト

#### 一般ユーザーアカウント
- **メール**: `user1@test.com` / **パスワード**: `password123`
- **権限**: テスト組織Aの一般ユーザー
- **用途**: チェック機能のテスト

## 機能別テストシナリオ

### 組織管理者登録のテスト

1. http://localhost:3000/auth/organization-signup にアクセス
2. 新しい組織名とユーザー情報を入力
3. 登録後、30日間のトライアル期間が設定されることを確認
4. 管理者権限でログインできることを確認

### ユーザー招待システムのテスト

#### 招待送信（管理者として）
1. `admin@test.com`でログイン
2. http://localhost:3000/admin/users にアクセス
3. 新しいユーザーを招待
4. コンソールに招待メールの内容が出力されることを確認

#### 招待承認（新規ユーザーとして）
1. 既存の招待URLでテスト: http://localhost:3000/auth/invitation?token=test-invitation-token-123
2. 組織情報とロールが正しく表示されることを確認
3. アカウント作成後、指定された組織に参加できることを確認

### チェック機能のテスト

#### 基本チェック
1. ログイン後、チェック画面にアクセス
2. 以下のテストテキストを入力:
   ```
   がんが治る奇跡のサプリメント！血圧が下がる効果があります。
   ```
3. 薬機法違反が検出されることを確認
4. 修正提案が表示されることを確認

#### ストリーミングチェック
1. APIエンドポイント `/api/checks/[id]/stream` の動作確認
2. リアルタイムでチェック結果が更新されることを確認

### 辞書管理のテスト

管理者アカウントで以下をテスト：

1. 新しいNG/ALLOW表現の追加
2. 既存エントリの編集
3. 削除機能
4. カテゴリ別フィルタリング

## テストデータの詳細

### 組織データ

| 組織名 | プラン | 上限チェック数 | 使用済み | トライアル期限 |
|--------|--------|---------------|----------|----------------|
| テスト組織A | trial | 200 | 3 | 30日後 |
| テスト組織B | basic | 1000 | 1 | なし |
| サンプル薬局 | trial | 200 | 0 | 25日後 |

### 辞書データサンプル

#### NG表現（テスト組織A）
- `がんが治る` - 重篤な疾患の治療効果を標榜
- `コロナに効く` - 感染症治療効果の標榜
- `血圧が下がる` - 医薬品的効果の標榜
- `糖尿病改善` - 疾患治療効果の標榜
- `免疫力アップ` - 医薬品的効果の標榜

#### ALLOW表現（テスト組織A）
- `健康維持` - 一般的な健康表現
- `おいしい` - 味覚に関する表現
- `栄養豊富` - 栄養成分に関する表現

### チェック履歴サンプル

テストアカウントには以下の履歴が用意されています：

1. **完了済みチェック**: 薬機法違反の検出・修正例
2. **処理中チェック**: ストリーミング機能のテスト用
3. **違反記録**: 検出された違反の詳細データ

## API エンドポイントのテスト

### curl でのテスト例

#### ユーザー招待
```bash
curl -X POST http://localhost:3000/api/users/invite \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "role": "user"}'
```

#### 招待情報取得
```bash
curl "http://localhost:3000/api/users/invitation-info?token=test-invitation-token-123"
```

## トラブルシューティング

### よくある問題

1. **シードが失敗する**
   - Supabaseが起動していることを確認: `supabase status`
   - データベースをリセット: `npm run db:reset`

2. **ログインできない**
   - パスワードが正しいか確認: `password123`
   - メールアドレスにタイポがないか確認

3. **招待URLが動作しない**
   - トークンが正しいか確認
   - トークンの有効期限（7日間）を確認

### ログ確認

開発中は以下でログを確認できます：

```bash
# Supabaseログ
supabase logs

# Next.jsサーバーログ
# ターミナルの出力を確認
```

## リセット方法

テストデータを初期状態に戻したい場合：

```bash
# データベースをリセットしてシードを再実行
npm run seed
```

これでテストデータが初期状態に戻ります。 